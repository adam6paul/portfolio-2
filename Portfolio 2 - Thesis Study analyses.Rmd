---
title: "Portfolio 4 - Thesis study 1"
author: "Adam Paul"
date: "3/24/2022"
output: html_document
---

> The purpose of this portfolio is to run the analyses for study 1 of my thesis.

## Set-up

The main packages I need are lavaan and lmertest, but semPlot is used to create a visual model. The rest of the libraries are to ensure I have the other programs I may need.


library('psych')
library('reshape2')
library('dplyr')
library('lavaan')
library('Rcpp')
library('lme4')
library('lmerTest')
library('OpenMx')
library('semPlot')
library('tidyverse')

rm(list=ls())

##### Bringing in the data

In the spirit of full disclosure, this was done prior to doing the data cleaning in portfolio 1. Instead, when I was working on my thesis I did my data cleaning in SPSS (which I expect I will continue to do, though it's nice to have learned how to do it in R)

As such, the data will be returned from SPSS here. In the fully put together version, I will combine with the data from portfolio 1, but I want to ensure things are accurate here.

```{r temporary data returning}
`study1` <- read.csv("~/Master's Program Wake Forest/Research/Online Belonging/Thesis Study 1/Online Course Experiences (SPSS cleaned).csv")
View(study1)
```

Ensuring the dataframe is a tibble.

as_tibble(study1)

------------------

# MEDIATION MODEL DETAILS

------------------

> This section is information given to me by Shannon, kept here and in other path analysis portfolios so I have access to them.

Reminder: Rules of thumb to evaluate goodness of fit: CFI/TLI > 0.95, RMSEA < 0.05, SRMR < 0.06  (Reference: Hu & Bentler, 1999)

### References: 
> http://davidakenny.net/cm/fit.htm
 https://www.psychologie.uzh.ch/dam/jcr:ffffffff-b371-2797-0000-00000fda8f29/chisquare_diff_en.pdf
 Chi-Square Distribution Table: http://sites.stat.psu.edu/~mga/401/tables/Chi-square-table.pdf
 http://www.structuralequations.com/resources/Basic_lavaan_Syntax_Guide_Aug1_2013.pdf

------------------

# Current settings 

------------------

### Resampling 
 Right now, bootstraps are set at 1000 resamples. This to make running the script not take impossibly long
 When running final models, 10000 resamples would probably be preferred - but it'll take a while. 

### Type of CIs
 lavaan can handle four types of bootstrapped CIs; add "boot.ci.type = " to parameterEstimates
 options for types are "norm", "basic", "perc" (percentile), and "bca.simple" 
 defualt is "perc" (I think )

### Significance Levels
 alpha level for bootstrapping can be adjusted; add "level = " to parameterEstimates 
 options for levels are e.g., "95", "99"

------------------

## Analyses!

------------------

##### Hypotheses

H1: Students who disclose in a class or small group will report higher feelings of belonging in the class and at their institution.

H2: Prompting disclosure in class or in small groups will be associated with greater disclosure and greater sense of belonging at the classroom and institutional level, as well as whether the relationship between disclosure and institutional belonging is mediated by classroom belonging.

All of this can be answered with a single path analysis, but before getting there I need to do some basic examinations of the data.


Looking at the basic information for class disclosure.

```{r}
summary(study1$class_belong_comp4)
summary(study1$school_belong_comp4)
summary(study1$cdiscl_prompt_comp2)
summary(study1$class_disclose_comp2)
summary(study1$group_disclose_comp2)
summary(study1$gdiscl_prompt_comp2)

```

It's noteworthy that there is a large number of the sample that do not have responses for group disclosure.

I'd like to look at the basic bivariate correlations for the VOI.

This only works with Hmisc on, but that contradicts my later use of summarize. Therefore, I turn on Hmisc for this part, and turn it off after. 

library('Hmisc')

```{r bivariate correlations}
correlations <- study1 %>%
        select(class_belong_comp4, school_belong_comp4, class_disclose_comp2, group_disclose_comp2, cdiscl_prompt_comp2, gdiscl_prompt_comp2)

rcorr(as.matrix(correlations))
    
```

#### Creating the model!

Now that we have an understanding of the data, it's time to move on to the model.

>These are the covariates I am including in the model:
Gender, with female as the reference class: 
        gender_identity_dich 
Race, with white as the reference class: 
        race_asian race_black race_hispanic race_multiracial 
Classmates and group members known prior:
        classmates_know groupdesc_know_prior


##### Model 1

```{r Revised model}
model_1 <-   '  #Class Belonging direct effects
                class_belong_comp4 ~ a*cdiscl_prompt_comp2 + gender_nonbinary +                             gender_male_dummy + race_asian + race_black + race_hispanic +                                race_multiracial + class_know_prior + know_prior_group
                
                class_belong_comp4 ~ b*gdiscl_prompt_comp2
                
                #School Belonging direct effects
                school_belong_comp4 ~ c*cdiscl_prompt_comp2 + gender_nonbinary +                            gender_male_dummy + race_asian + race_black + race_hispanic +                                race_multiracial + class_know_prior + know_prior_group
                
                school_belong_comp4 ~ d*gdiscl_prompt_comp2
                
                #Mediator for class disclosure
                class_disclose_comp2 ~ e*cdiscl_prompt_comp2
                class_belong_comp4 ~ f*class_disclose_comp2
                school_belong_comp4 ~ class_disclose_comp2
                
                #Mediator for group disclosure
                group_disclose_comp2 ~ g*gdiscl_prompt_comp2
                class_belong_comp4 ~ h*group_disclose_comp2
                school_belong_comp4 ~ group_disclose_comp2
                
              #indirect effect (class disclosure)
                class_indirect := e*f
                
                
              #indirect effect (group disclosure)
                group_indirect := g*h
              
              #total effect class
                total_class_c := a + (e*f)
                total_group_c := c + (e*f)
                
              #Total effect group
                total_class_g := b + (g*h)
                total_group_g := d + (g*h)
              
              
              #covariance
                class_disclose_comp2 ~~ group_disclose_comp2
                
              #removing correlation between prompted disclosures
                cdiscl_prompt_comp2 ~~ 0*gdiscl_prompt_comp2
                
                '
```


```{r testing fit}
fit1 <- sem(model_1, data=study1)

summary(fit1, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)

```

>Model Test User Model:
                                                      
> Test statistic                               125.880
  Degrees of freedom                                35
  P-value (Chi-square)                           0.000

> Comparative Fit Index (CFI)                    0.673
  RMSEA                                          0.156
  SRMR                                           0.114

The fit is not very good for this model, which is a concern.

>Regressions:
                         Estimate  Std.Err  z-value  P(>|z|)
  Class belonging                                                       
Key variables
    Class disclosure        0.189    0.178    1.063    0.288
    Class prompted discl    0.185    0.120    1.549    0.121
    Group disclosure        0.065    0.157    0.416    0.678
    Group prompted discl   -0.047    0.121   -0.387    0.699
Others
    Nonbinary              -1.069    0.565   -1.893    0.058 
    Asian                  -1.037    0.359   -2.891    0.004
    Classmates known        0.479    0.142    3.371    0.001  
    Study known            -0.235    0.127   -1.846    0.065  

> School belonging                                                       
Key variables
    Class disclosure       -0.144    0.151   -0.954    0.340
    Class prompted discl    0.241    0.102    2.367    0.018
    Group disclosure        0.221    0.134    1.651    0.099
    Group prompted discl   -0.140    0.103   -1.350    0.177  
Others
    Nonbinary              -0.532    0.482   -1.105    0.269 
    Asian                  -0.676    0.306   -2.212    0.027  
    Classmates known        0.297    0.121    2.453    0.014   
    Study known            -0.122    0.108   -1.124    0.261  
 
> Covariances:
                                    Estimate  Std.Err  z-value  P(>|z|)
                                                     
> Class and Group disclosure          0.549    0.091    6.055    0.000
                                                       
> Class and school belonging          0.466    0.100    4.648    0.000


We replicated our finding that Asian is a negative predictor of belonging. While marginal for class belonging, non binary is also a negative predictor.

class members known prior is a predictor of belonging and group members known is marginal.

```{r bootstrapped code}
fit1 <- sem(model_1, data=study1, se="bootstrap", bootstrap = 10000)
summary(fit1, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)
```


> Class disclosure is not predicting class belonging or school belonging, which is odd. So I want to find out why.

Because of the earlier bivariate correlations, we know that both disclosures are highly correlated. 
This suggests to us that it would be worth looking at the path models of each level of our predicted model.


# Should make changes
##### Possibility 1! Lost data

Looking at the results from model_1, we're also losing a lot of our sample. This may be because it's excluding anyone who did not use a group, as they have no data on group disclosure. I examine this possibility below.

```{r}
study1 %>%
        group_by(group_use) %>%
        summarize(freq=n())
#Most people are saying they don't use groups at all (123 with no usage).
```

The graph makes it clear that there's pretty wide variance for the people with no class disclosure. That may be stifling the variance among people who do disclose from appearing in the model.

So now, we want to look at what's happening without group disclosure.


##### Class Only model

While model_1 is good, it is washing out a lot of data from the class disclosure as we only got responses for group disclosure from students who did meet in groups. As such, we're interested in examining the full class disclosure data set.


```{r just class model}
model_class <-   '  #Class Belonging direct effects
                class_belong_comp4 ~ a*cdiscl_prompt_comp2 + gender_nonbinary +                             gender_male_dummy + race_asian + race_black + race_hispanic +                                race_multiracial + class_know_prior
                
                #School Belonging direct effects
                school_belong_comp4 ~ d*cdiscl_prompt_comp2 + gender_nonbinary +                            gender_male_dummy + race_asian + race_black + race_hispanic +                                race_multiracial + class_know_prior
                
                #Mediator for class disclosure
                class_disclose_comp2 ~ b*cdiscl_prompt_comp2
                class_belong_comp4 ~ c*class_disclose_comp2
                school_belong_comp4 ~ class_disclose_comp2
                
                #indirect effect (class disclosure)
                indirect := b*c
                
                #total effect
                total_class := a + (b*c)
                total_school := d + (b*c)
                '
```


```{r testing fit}
fit_class <- sem(model_class, data=study1)

summary(fit2, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)

```

>Regressions:
                                     Estimate  Std.Err  z-value  P(>|z|)   
  Class Belonging                                                        
Key variables
    Class disclosure                   0.325    0.096    3.377    0.001
    Class prompted disclosure          0.094    0.084    1.115    0.265
Others    
    Nonbinary                         -0.651    0.360   -1.808    0.071
    Asian                             -0.653    0.226   -2.891    0.004
    Class known prior                  0.132    0.061    2.150    0.032

> School belonging
    Class Disclosure                   0.114    0.085    1.334    0.182
    Class prompted disclosure          0.062    0.075    0.829    0.407
Others
    Asian                             -0.594    0.201   -2.960    0.003
    Class known prior                  0.188    0.055    3.446    0.001

> MEDIATION
>   Class disclosure  
       Prompted disclosure             0.461    0.042   10.933    0.000
       Indirect effect                 0.150    0.046    3.227    0.001
       total_class                     0.244    0.073    3.350    0.001
       total_school                    0.212    0.078    2.731    0.006

```{r bootstrapped code}
fit_class1 <- sem(model_class, data=study1, se="bootstrap", bootstrap = 10000)
summary(fit_class1, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)
```






##### Group Only Model

```{r Group only model}
model_group <-   '  #Class Belonging direct effects
                class_belong_comp4 ~ a*gdiscl_prompt_comp2 + gender_nonbinary +                                     gender_male_dummy + race_asian + race_black + race_hispanic +                                       race_multiracial + class_know_prior + know_prior_group

                #School Belonging direct effects
                school_belong_comp4 ~ d*gdiscl_prompt_comp2 + gender_nonbinary +                                    gender_male_dummy + race_asian + race_black + race_hispanic +                                       race_multiracial + class_know_prior + know_prior_group

                #Mediator for group disclosure
                group_disclose_comp2 ~ b*gdiscl_prompt_comp2
                class_belong_comp4 ~ c*group_disclose_comp2
                school_belong_comp4 ~ group_disclose_comp2
                
              #indirect effect (group disclosure)
                indirect := b*c

              #Total effect group
                total_class := b + (b*c)
                total_group := d + (b*c)
                '
```

```{r testing fit}
fit_group <- sem(model_group, data=study1)

summary(fit_group, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)

```

> Model Test User Model:
                                                      
> Test statistic                                 8.377
  Degrees of freedom                                 8
  P-value (Chi-square)                           0.398

> Comparative Fit Index (CFI)                    0.996
  RMSEA                                          0.021
  SRMR                                           0.029

>Regressions:
                         Estimate  Std.Err  z-value  P(>|z|)
  Class belonging
Key variables
    Group disclosure        0.198    0.111    1.790    0.073 
    Group prompted discl    0.114    0.124    0.921    0.357
Others
    Nonbinary              -0.972    0.574   -1.695    0.090
    Asian                  -1.086    0.367   -2.962    0.003
    Classmates known        0.493    0.145    3.409    0.001  
    Study known            -0.250    0.129   -1.936    0.053  
  
>  School belonging                                                      
    Group disclosure        0.143    0.094    1.520    0.128
    Group prompted discl    0.037    0.105    0.349    0.727 

> MEDIATION
    Group disclosure                                                     
    Group prompted discl    0.427    0.096    4.458    0.000
     indirect effect        0.085    0.051    1.661    0.097
     total_class            0.511    0.124    4.122    0.000
     total_group            0.121    0.109    1.116    0.264

```{r bootstrapped code}
fit_group1 <- sem(model_group, data=study1, se="bootstrap", bootstrap = 10000)
summary(fit_group1, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)
```

##### Possibility 2! Low Disclosure

Another issue that there may be very few people actually disclosing.
This may be because people are mostly at a 1 in disclosure.

```{r looking at disclosure}
#Looking at the numbers
study1 %>%
        group_by(class_disclose_comp2) %>%
        summarize(freq=n())
#111 at 1, 32 at 1.5, and 88 at 2; or 77% of the sample. 

#Just looking at the distribution of disclosure
hist(study1$class_disclose_comp2)

#Graphing the relationship between class disclosure and class belonging.
plot(study1$class_disclose_comp2, study1$class_belong_comp4)

study1 %>%
        group_by(class_disclose_comp2) %>%
        summarize(mean(class_belong_comp4))
```

In our sample, 231 participants have disclosure lower than 2 on our composite variable. Additionally, looking at the graph shows that there is pretty substantial variance within the lowest level of disclosure.


```{r looking closer at the disclosure levels}
study1 %>%
        group_by(cdiscl_private) %>%
        summarize(freq=n())
#132 are at 1 (Never), and 118 are at 2 (Rarely); or 83% of our sample

study1 %>%
        group_by(cdiscl_self_talk) %>%
        summarize(freq=n())
#127 at 1, 108 at 2; 78% of our sample
```


As expected, a large portion of our participants are not reporting any disclosure. Looking at some responses on an open-ended comment, several students indicated they were in wholly asynchronous classes. One possibility is that there are many individuals in asynchronous classes, but there also may be very little disclosure in synchronous classes.


What we do know is that there is tremendous variance within people reporting no disclosure. This may be suppressing our ability to examine the variance between disclosure levels.

And so, we will run the model again, but this time dropping anyone who has no disclosure at all. While this does eliminate a key segment of data, it is valuable to know what is going on.


> Subsetting data to exclude anyone with a disclosure under 2


```{r running with only people who have some disclosure}
study1a <- study1[study1$class_disclose_comp2 > 1,]
```


```{r testing fit}
fit_discl_no1 <- sem(model_group, data=study1a)

summary(fit_discl_no1, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)

```

While we lost a LOT of participants, leaving us with a sample of only n=83, we do see that when we remove people whom have no disclosure there is a relationship between class disclosure and school belonging. The relationship between class belonging for both variables remains non-significant.

  >class Belonging                                                        
     Class disclosure   Est= -0.059     SE=0.143        p=0.681
     Group disclosure   Est=0.100       SE=0.121        p=0.410
   School Belonging
     Class disclosure   Est=-0.380      SE=0.123        p=0.002
     Group disclosure   Est=0.272       SE=0.104        p=0.009






#### Graphing!

It's important to get a visual understanding of what the data is telling us, even if the model is pretty ugly right now. I will work with Mason to get a pretty visualization.

```{r Path visualization}
semPaths(fit1, whatLabels="par", layout="tree", nCharNodes=0, sizeMan=12, sizeMan2=6)

semPaths(fit2, whatLabels="par", layout="tree", nCharNodes=0, sizeMan=12, sizeMan2=6)

semPaths(fit3, whatLabels="par", layout="tree", nCharNodes=0, sizeMan=12, sizeMan2=6)
```

#### Bootstrapping

#####for boot strapped 95% CIs

```{r bootstrapped code}
fit <- sem(model_1, data=Classroom_Experiences, se="bootstrap", bootstrap = 10000)
summary(fit, fit.measures=TRUE, standardize=TRUE, rsquare=TRUE)
```


# What does the data mean?

>This section will be used for me to write up what I've learned from the data analysis, as a point to reference the findings while I'm working later.

>H1: Students who disclose in a class or small group will report higher feelings of belonging in the class and at their institution.

XXXXXXXXXXXXXXXXXXXXXXXX

>H2: Prompting disclosure in class or in small groups will be associated with greater disclosure and greater sense of belonging at the classroom and institutional level, as well as whether the relationship between disclosure and institutional belonging is mediated by classroom belonging.

XXXXXXXXXXXXXXXXXXXXXXXX